## 5. Ошибка типа «переполнение буфера». Выполнение произвольного кода на исполнимом стеке. Противодействие выполнению кода на стеке: «канарейка», DEP.

* **118** — Improper Access of Indexable Resource (‘Range Error’)
    - **119** — Improper Restriction of Operations within the Bounds of a Memory
      Buffer
        + **788** — Access of Memory Location After End of Buffer
            * **126** — Buffer Over-read
            * **122** — Heap-based Buffer Overflow
            * **121** — Stack-based Buffer Overflow
        + **786** — Access of Memory Location Before Start of Buffer
            * **127** — Buffer Under-read
            * **124** — Buffer Underwrite (‘Buffer Underflow’)

### CWE-121 Stack-based Buffer Overflow

* Программа осуществляет запись в буфер, размещенный на стеке, по неверному
  индексу, превышающему наибольший допустимый.

* Ошибка типична для языков Си и Си++, а также для ассемблера.

* Возможные последствия эксплуатации уязвимости:

    - нарушение доступности — аварийное завершение или зависание программы;

    - нарушение конфиденциальности, целостности и доступности — перехват потока
      управления, внедрение произвольного кода.

* CWE оценивает вероятность эксплуатации как очень высокую.

### Подготовка эксплоита

1. Анализ исходного кода программы, обнаружение ошибки переполнения буфера.

2. Анализ бинарного кода программы, его разметка в соответствии с исходным.

3. Подготовка карты стека на момент переполнения:

    - расположение переменной buf;

    - расположение сохранённого адреса возврата.

4. Проработка допустимого формата содержимого эксплоита:

    - шаблон с расположением фиксированных полей (поле адреса возврата);

    - ограничения на значения отдельных байтов.

5. Оформление окончательного вида эксплоита: конкретные значения байтов с
   внедрённой полезной нагрузкой.

### Условия реализации атаки

1. **Исполнимый стек**: внедряемый код размещён на стеке. Если система не позволяет
   выполнять код из диапазона адресов, относящегося к стеку, атака не удастся.

2. **Относительно корректное завершение функции**: после того, как перезаписан адрес
   возврата и предшествующие ему значения в стеке, функция должна доработать до
команды ret, чтобы выполнился внедряемый код.

3. **Постоянные адреса**: в рамках последовательных запусков программы адреса
   объектов в стеке не должны меняться, т.к.  иначе перезаписанный адрес
возврата перестанет быть корректным, и вместо перехвата потока управления можно
будет получить лишь аварийное завершение программы.

### Противодействие выполнению кода на стеке

**Неисполнимый стек (W^X, DEP)** — технология, позволяющая помечать сегменты или
страницы памяти как неисполняемые. При попытке передать управление на код,
размещённый в такой памяти, происходит аварийное завершение процесса.

Аппаратно поддерживается на уровне страничной трансляции во всех процессорах
x86_64, а также в более новых x86 и ARM.

В более старых моделях x86 возможна более медленная и сопряжённая с
дополнительными ограничениями на исполнимые файлы реализация с использованием
сегментной трансляции.

### «Канарейка» на стеке

Общая идея: проверять факт перезаписи стека непосредственно перед адресом
возврата перед выходом из функции.

**«Канарейка»** — как правило случайное значение, которое размещается на стеке перед
адресом возврата. Перед выходом из функции происходит сравнение значения в стеке
с исходным значением. Если значения не совпадают, программа аварийно
завершается.

### Обход «канарейки» на стеке

1. «Канарейка» проверяется только перед выходом из функции, однако перехват
   потока управления может быть осуществлён раньше (перезаписываемый указатель
на функцию).

2. «Канарейка» может быть перезаписана, если в функции есть ошибка CWE-123
   (‘Write-what-where Condition’).

3. Если программа содержит, например, ошибку CWE-126 (‘Buffer Over-read’), или
   возможны множественные попытки (brute force), то значение «канарейки» может
быть извлечено из стека, после чего возможна эксплуатация переполнения буфера с
известным значением «канарейки»

4. Перехват обработчика исключения на Windows (SEH-эксплоит).
