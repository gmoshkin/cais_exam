## 11. Применение отладки для оценки возможности эксплуатации уязвимостей.  Технологии отладки. Отладка пользовательского кода. Полносистемная отладка в виртуальной машине.

### Тестирование и отладка

 Тестирование и отладка — динамические подходы к анализу

программ.

 Тестирование отвечает на вопрос «что необходимо сделать, чтобы

сломать программу».

 Отладка отвечает на вопрос «что необходимо сделать, чтобы

починить программу».

© 2016 МГУ / ВМК / СП 3

«Борбаги» и «гейзенбаги»

«Борбаг» (“bohr bug”) — ошибка, которая не исчезает и не меняет своих

свойств при попытке её обнаружения.

«Гейзенбаг» (“heisenbug”) — ошибка, которая исчезает или меняет свои

свойства при попытке её обнаружения.

Распространённые причины «гейзенбагов»:

 использование неинициализированной переменной;

 состояние гонки.

© 2016 МГУ / ВМК / СП 4

Отладка пользовательского кода

 “Print-debugging” — добавление в программу вывода значений

переменных в окрестности ошибки.

 Бисекция (“wolf fence” algorithm) — способ локализации ошибки:

 временное отключение частей кода с поиском того момента,

когда ошибка перестаёт воспроизводиться;

 либо, наоборот, последовательное включение частей кода с

поиском того момента, когда ошибка начнёт воспроизводиться.

 Применение отладчика:

 локальная отладка (на той же самой машине);

 удалённая отладка (через сетевое соединение).

 Отладчик подключается к выполняющемуся процессу либо к дампу

памяти (core dump), полученному при аварийном завершении

программы.

© 2016 МГУ / ВМК / СП 5

Отладочная информация

 Компилируемая программа отлаживается на уровне машинных

команд (или команд виртуальной машины соответствующего языка,

например, Java VM).

 Требуется сопоставление объектов низкого уровня (адресов,

неструктурированных данных) с объектами высокого уровня

(функциями, строками кода, типизированными данными).

 Компилятор может выдавать отладочную информацию,

описывающую соответствие между сгенерированным бинарным

кодом и исходным кодом, из которого он был получен.

 Форматы отладочной информации:

 DWARF — отладочная информация в секциях ELF-файлов;

 Microsoft PDB — отладочная информация в отдельном PDB-файле,

поддерживает загрузку по сети («серверы символов»).

© 2016 МГУ / ВМК / СП 6

DWARF

 Типы данных, используемые в программе (поддержка основных

компилируемых языков программирования — Си, Си++, Fortran, Ada

и родственных).

 Точки входа — адреса начал функций, их имена и сигнатуры.

 Отображение адресов в бинарном коде на имена файлов и номера

строк исходного кода.

 Описание переменных: имена, типы, расположение. Поскольку

расположение переменных в общем случае не является

фиксированным во время выполнения программы (переменные на

стеке, области с относительной адресацией), DWARF включает язык

выражений, позволяющий описывать способ вычисления адреса

объекта в общем виде.

© 2016 МГУ / ВМК / СП 7

Базовый функционал отладчика

Точка останова (breakpoint) — адрес команды, при достижении

которого выполнение программы должно быть приостановлено.

Точка отслеживания (watchpoint) — адрес ячейки памяти, при

обращении к которой на чтение или запись выполнение

программы должно быть приостановлено.

Пошаговое выполнение программы — выполнение одной машинной

команды или одной строки исходного кода (с использованием

отладочной информации).

В момент, когда выполнение программы приостановлено, отладчик

предоставляет возможность просмотра содержимого регистров

и памяти.

© 2016 МГУ / ВМК / СП 8

Аппаратная поддержка отладки

Точки останова

Точки останова реализуются через внедрение команды INT 3 в тело

программы по требуемому адресу.

 Команда INT 3 кодируется единственным байтом 0xCC.

 Отладчик сохраняет содержимое первого байта по адресу точки

останова и заменяет его в загруженном в память образе

программы на команду INT 3.

 При достижении потоком управления команды INT 3 процессор

генерирует отладочное прерывание, которое при поддержке со

стороны операционной системы перехватывается отладчиком.

 Операционная система приостанавливает выполнение потока, в

котором возникло прерывание, до дальнейших указаний от

отладчика.

© 2016 МГУ / ВМК / СП 9

Аппаратная поддержка отладки

Пошаговое выполнение

Установка бита TF в регистре RFLAGS приводит к тому, что после

выполнения каждой очередной команды генерируется отладочное

исключение.

Таким образом может быть обеспечен пошаговый просмотр состояния

программы на границах команд.

© 2016 МГУ / ВМК / СП 10

Аппаратная поддержка отладки

Точки отслеживания

Архитектура x86 (и x86-64) включает отладочные регистры DR0..DR7,

позволяющие, в том числе, задать четыре точки отслеживания.

Для каждой точки отслеживания указывается виртуальный адрес,

размер (1, 2, 4 или 8 байтов) и один из четырёх режимов:

 отслеживать только выборку команд;

 отслеживать только обращения на запись;

 отслеживать любые обращения;

 отслеживать обращения на чтение и запись данных, но не

выборку команд.

Таким образом, этот механизм позволяет также задавать и точки

останова без модификации образа программы в памяти.

© 2016 МГУ / ВМК / СП 11

Обратимая отладка

Обратимая отладка (reversible debugging) — технология, позволяющая

отладчику двигаться не только от текущего состояния

программы к последующим («вперёд во времени»), но и в

обратную сторону («назад во времени»).

Когда может быть полезна обратимая отладка?

Реализация обратимой отладки предполагает сохранение отладчиком

достаточного количества информации для обращения

выполнения команд.

Какая информация должна быть сохранена?

© 2016 МГУ / ВМК / СП 12

Обратимая отладка в GDB

GDB начиная с версии 7.0 (2009 г.) поддерживает обратимую отладку,

добавляя новые команды.

Команды обратимой отладки:

 reverse-continue — выполнение программы назад до достижения

состояния останова (breakpoint, watchpoint или точки входа в

программу);

 reverse-finish — выполнение программы назад до входа в текущий

фрейм;

 reverse-next, reverse-nexti — шаг назад на одну строку;

 reverse-step, reverse-stepi — шаг назад на одну машинную

команду.

© 2016 МГУ / ВМК / СП 13

Антиотладочные приёмы

 Обнаружение точек останова и слежения:

 сканирование образа программы во время выполнения: поиск

байтов 0xCC, вычисление контрольных сумм;

 запрос информации об аппаратных точках останова и слежения.

 Обнаружение наличия отладчика через API-вызовы и флаги в

управляющих структурах операционной системы.

 Приёмы, основанные на замерах времени.

 «Самоотладка».

 Эксплуатация известных уязвимостей в распространённых

отладчиках.

 Обфускация кода.

 Выполнение кода в виртуальной машине.

 Как бороться с антиотладочными приёмами?

© 2016 МГУ / ВМК / СП 14

ПОЛНОСИСТЕМНАЯ ОТЛАДКА

0602

Полносистемная отладка

 Локальная отладка с помощью ядерного отладчика:

 Windows — KD, WinDBG.

 Удалённая отладка с подключением по сети:

 требуется явная поддержка со стороны отлаживаемой

операционной системы.

 Удалённая отладка с подключением через аппаратный отладочный

интерфейс (ICE, JTAG):

 требуется отдельная машина с интерфейсом;

 требуется дополнительная аппаратура для подключения к

интерфейсу отладки.

 Удалённая отладка в виртуальной машине.

© 2016 МГУ / ВМК / СП 16

Отладка в виртуальной машине

 Отладка может выполняться в полносистемном эмуляторе

(виртуальной машине), например, в QEMU.

 В этом случае отладчик (GDB) подключается не к выполняющемуся

на той же машине процессу, а через сетевое соединение к ответной

части (GDB debugging stub) в эмуляторе.

Основное преимущество отладки в виртуальной машине — исключение

влияния наличия отладчика на поведение отлаживаемой

системы.

Какое исключение относится к вышеуказанному преимуществу?

Основные недостатки — относительная сложность подготовки

окружения и семантический разрыв.

© 2016 МГУ / ВМК / СП 17

Семантический разрыв

 Полносистемная отладка предоставляет полную информацию о

состоянии машины.

 Имеется возможность отладки драйверов и ядра ОС: можно

обращаться к структурам данных, которые недоступны обычным

отладчикам.

 Вместе с тем, отладка осуществляется на низком уровне (значения

регистров, неинтерпретируемое содержимое памяти и т.д.).

 Существует семантический разрыв — состояние системы как его

«понимает» отладчик и как его понимает оператор, находятся на

разных уровнях.

 Пример: получение списка работающих потоков выполнения.

 Пример: получение информации о загруженных в текущий процесс

динамических библиотеках.

© 2016 МГУ / ВМК / СП 18

0:000>0: kd> !process 0 0

**** NT ACTIVE PROCESS DUMP ****

PROCESS ffffe000002287c0

SessionId: none Cid: 0004 Peb: 00000000 ParentCid: 0000

DirBase: 001aa000 ObjectTable: ffffc00000003000

Image: System

PROCESS ffffe00001e5a900

SessionId: none Cid: 0124 Peb: 7ff7809df000 ParentCid: 0004

DirBase: 100595000 ObjectTable: ffffc000002c5680

Image: smss.exe

Сужение семантического разрыва

 Специальная поддержка гостевого окружения в полносистемном

отладчике позволяет упростить отладку.

 Например, отладчик WinDbg позволяет получить информацию о

состоянии ОС в понятном оператору виде.

© 2016 МГУ / ВМК / СП 19

Как это реализовано?

Детерминированное воспроизведение

 Некоторые ошибки, связанные с временными характеристиками

выполения, перестают воспроизводиться при отладке программы в

виртуальной машине.

 Пример: состояние гонки.

 Пример: взаимодействие с удалённым агентом по сети.

 Решение — детерминированное воспроизведение:

 первый проход (record) — сбор журнала недетерминированных

событий;

 второй проход (replay) — воспроизведение журнала событий с

подключением отладчика.

 Реализовано в основной ветви эмулятора QEMU.

© 2016 МГУ / ВМК / СП
